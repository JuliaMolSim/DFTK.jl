using Test
using DFTK: Model, PlaneWaveBasis, r_to_G, load_psp, Species, term_nonlocal, kblock

include("testcases.jl")

@testset "term_nonlocal" begin
    Ecut = 2
    fft_size = [9, 9, 9]
    model = Model(silicon.lattice, silicon.n_electrons)
    basis = PlaneWaveBasis(model, fft_size, Ecut, silicon.kcoords, silicon.ksymops)
    function build_nonlocal(composition...)
        _, pot = term_nonlocal(composition...)(basis, nothing, zeros(basis.fft_size))
        pot
    end

    psp = load_psp("Si-lda-q4.hgh")
    potnl = build_nonlocal(psp => silicon.positions)
    @testset "Agreement of psp and species construction" begin
        Si = Species(14, psp=psp)
        potnl2 = build_nonlocal(Si => silicon.positions)

        for kpt in basis.kpoints
            potblock = kblock(potnl, kpt)
            potblock2 = kblock(potnl2, kpt)
            @test potblock.proj_coeffs ≈ potblock2.proj_coeffs
            @test potblock.proj_vectors ≈ potblock2.proj_vectors
        end
    end

    @testset "Dummy application test for ik == 3" begin
        ik = 3
        indata = [
                -0.640400562142635 + 0.898567000641167im,
                -1.108014547818237 - 0.885953475815932im,
                 0.494405381590111 + 0.287288488638199im,
                -1.001575897799888 + 0.870082815083341im,
                -0.211631360726485 - 0.632987622400337im,
                -0.411567584267209 - 0.450748133246067im,
                -0.852734350491328 - 0.193861734050918im,
                 1.179308962514997 - 0.960771645503564im,
                 1.135236456512953 - 0.882086585122137im,
                 1.395142911307744 + 1.041341743360690im,
                -0.083966494878402 - 0.229857812607235im,
                -0.904873557908504 + 0.885060907911802im,
                -0.567518036138447 - 0.504216172395614im,
                -0.424816071050916 - 0.111900032249434im,
                 0.392936266734690 - 0.299422211978599im,
                -0.852871800144458 - 0.626073507676170im,
                 0.362355373361757 + 0.339279995710525im,
                -1.313301095759243 + 0.576559053785310im,
                 0.658391226771473 + 0.187539205337705im,
                 1.435436026190541 + 0.500125109518501im,
                -1.598749791935228 - 0.938158813040609im,
                -0.185036551693547 + 0.711443914237854im,
                -0.873625742125268 - 0.752328949884127im,
                 0.526532274543671 + 0.865298723362931im,
                -0.646350745468529 - 0.001697619931694im,
                 0.727218660962281 + 0.832738101265709im,
                -0.854953485548827 - 0.675454999860706im,
                 0.084437279880599 - 0.917982125488614im,
                -0.669240123857311 - 0.466221951703651im,
                 1.503456286287176 - 0.240445921025460im,
                 0.976083612807345 - 0.383324204563494im,
                 1.080754336957168 - 2.111931879341930im,
                -0.539478766374316 + 0.605130112538174im,
                 0.190050489252092 - 0.612025084308046im,
                 0.145245530463294 + 1.042881487285404im,
                -0.116266257190609 + 0.458970822312438im,
                -0.276774487883432 + 1.081765247633682im,
                 0.280146112622853 + 0.694587084385632im,
                -0.156712490356240 + 0.293106799940743im,
        ]

        ref = [
                -0.661458540029646 - 0.082794591434471im,
                -1.075625664669056 - 0.503375949116393im,
                 0.454798722816803 + 0.335736015438899im,
                 0.118852409952865 + 0.365397301351975im,
                -0.930575305605377 - 0.440137390959533im,
                -0.789010454467922 - 0.551989235721022im,
                -0.510685895869479 - 0.024252555317416im,
                 0.879579672156741 + 0.414261725472065im,
                 0.909713545111625 + 0.312421794345629im,
                 0.376478642226673 + 0.372069045459035im,
                -0.409471315232126 - 0.093231780757655im,
                 0.780704714350115 + 0.256176966690437im,
                 0.958753724828513 + 0.547737294665271im,
                -1.077644538179783 - 0.502154310180674im,
                -1.006076079419505 - 0.546061359602692im,
                -0.501141740278436 - 0.106935096941547im,
                -0.737582581028540 - 0.496427206674692im,
                -0.248461381154731 - 0.256350071896481im,
                -0.634096775078248 - 0.296198344656972im,
                -0.444241715773259 - 0.145713300567767im,
                -0.863579535720178 - 0.396247451729368im,
                 0.214723688664148 + 0.182336519729242im,
                -0.669559019587656 - 0.322839785689667im,
                -0.303583734326166 - 0.107189229919873im,
                -0.122327908258185 - 0.102495249501939im,
                 0.401793393907673 + 0.227028044713878im,
                -0.664819375385888 - 0.427157955221298im,
                -0.223675307884122 - 0.401062944893514im,
                -0.042419481816142 - 0.396368964475580im,
                 0.518363817193932 - 0.109543708638808im,
                 0.197953247492711 + 0.442100355521557im,
                 0.670748294416267 + 0.221952804436032im,
                 0.734586769528898 + 0.562364133287837im,
                 0.900231055058197 + 0.322001911508428im,
                -0.169801391954612 - 0.347544155606722im,
                 0.509774368280433 - 0.043497985918072im,
                 1.003080267919864 + 0.611998286215837im,
                 0.566674392785610 - 0.082276189544293im,
                 1.129738824134614 + 0.396626122727652im,
        ]

        out = kblock(potnl, basis.kpoints[ik]) * indata
        @test abs.(ref) ≈ abs.(out)
        @test ref ≈ out
    end

    @testset "Dummy application test for ik == 1" begin
        ik = 1
        indata = [
                -0.249942186371034 + 0.106882817996065im,
                 0.940498436200674 + 1.981742589455308im,
                -0.764734255392582 + 0.119481320101944im,
                -0.016471951537286 - 1.341888775918520im,
                 0.170023729290971 - 0.169369898303161im,
                 0.576577080218387 - 0.151180213314926im,
                 1.515166830138607 - 0.702936632612485im,
                 0.729309959715697 - 0.747348104357628im,
                 0.688019327859743 + 0.246345303113873im,
                 0.051305061843341 + 0.894651110143945im,
                 0.155706773410534 + 2.387103261046616im,
                -0.274114963159272 - 0.714394688123061im,
                -0.070824956158245 + 0.118772325947994im,
                -0.178293056461264 - 0.994971261517839im,
                 0.683885627321727 + 0.029449088646684im,
                -0.088304878756872 + 0.977530049532560im,
                -0.447961879173078 + 1.008628107418062im,
                -0.235209098230275 + 0.254042503117651im,
                 0.701729738822351 - 0.782607002266970im,
                -0.783152841007945 + 0.151480484555201im,
                -2.191219112369626 + 0.606200668406153im,
                 1.454572168658558 - 0.451555701758436im,
                -1.480654630668913 - 0.220250101767892im,
                 0.063395944850769 - 0.592946714649635im,
                 1.686701258275898 - 0.365462773744183im,
                 0.303276646718388 + 0.812516984581777im,
                -0.241446666780413 + 0.764299387418599im,
        ]

        ref = [
                -0.611230839433902 + 0.073149762338234im,
                -0.740534024997148 + 0.614096798136806im,
                 0.007613063892834 - 0.343072009313026im,
                -0.758317671722671 + 0.233158421378072im,
                -0.387478301036633 + 0.496079542421781im,
                -0.487729196927419 - 0.161197374796837im,
                 0.098782022426496 - 0.353713233963077im,
                -0.364044405703707 + 0.259170048637822im,
                 0.548312802698541 - 0.533853348548779im,
                -0.572458126277514 + 0.459535865326319im,
                -0.432732455885253 + 0.705332101832799im,
                -0.238779849341128 - 0.079727999141705im,
                -0.383072436743351 + 0.440349232340074im,
                 0.077487942271376 + 0.379809888834902im,
                 0.425547738399453 - 0.151114793715252im,
                 0.487390134011309 + 0.059068918002077im,
                -0.176937453729272 + 0.130455712575625im,
                 0.238440786425019 - 0.022400457653056im,
                 0.613332816206107 - 0.075572216187929im,
                -0.153952049480082 - 0.270866787458344im,
                -0.612993753289997 + 0.177700672982689im,
                 0.503058647849920 - 0.324600789137760im,
                -0.674836148901853 - 0.032483038734641im,
                 0.364383468619816 - 0.157041591843061im,
                 0.552718666991822 - 0.589583658630485im,
                 0.426225864231672 + 0.053142119874268im,
                 0.826232384929616 - 0.397431195427633im,
        ]
        out = kblock(potnl, basis.kpoints[ik]) * indata
        @test abs.(ref) ≈ abs.(out)
        @test ref ≈ out
    end
end
