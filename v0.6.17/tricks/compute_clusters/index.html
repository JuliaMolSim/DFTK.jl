<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Using DFTK on compute clusters · DFTK.jl</title><meta name="title" content="Using DFTK on compute clusters · DFTK.jl"/><meta property="og:title" content="Using DFTK on compute clusters · DFTK.jl"/><meta property="twitter:title" content="Using DFTK on compute clusters · DFTK.jl"/><meta name="description" content="Documentation for DFTK.jl."/><meta property="og:description" content="Documentation for DFTK.jl."/><meta property="twitter:description" content="Documentation for DFTK.jl."/><meta property="og:url" content="https://docs.dftk.org/stable/tricks/compute_clusters/"/><meta property="twitter:url" content="https://docs.dftk.org/stable/tricks/compute_clusters/"/><link rel="canonical" href="https://docs.dftk.org/stable/tricks/compute_clusters/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/favicon.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="DFTK.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">DFTK.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../features/">DFTK features</a></li><li><span class="tocitem">Getting started</span><ul><li><a class="tocitem" href="../../guide/installation/">Installation</a></li><li><a class="tocitem" href="../../guide/tutorial/">Tutorial</a></li><li><a class="tocitem" href="../../guide/periodic_problems/">Problems and plane-wave discretisations</a></li><li><a class="tocitem" href="../../guide/introductory_resources/">Introductory resources</a></li><li><a class="tocitem" href="../../school2022/">DFTK School 2022</a></li></ul></li><li><span class="tocitem">Basic DFT calculations</span><ul><li><a class="tocitem" href="../../examples/metallic_systems/">Temperature and metallic systems</a></li><li><a class="tocitem" href="../../examples/collinear_magnetism/">Collinear spin and magnetic systems</a></li><li><a class="tocitem" href="../../examples/convergence_study/">Performing a convergence study</a></li><li><a class="tocitem" href="../../examples/pseudopotentials/">Pseudopotentials</a></li><li><a class="tocitem" href="../../examples/supercells/">Creating and modelling metallic supercells</a></li><li><a class="tocitem" href="../../examples/gaas_surface/">Modelling a gallium arsenide surface</a></li><li><a class="tocitem" href="../../examples/graphene/">Graphene band structure</a></li><li><a class="tocitem" href="../../examples/geometry_optimization/">Geometry optimization</a></li><li><a class="tocitem" href="../../examples/energy_cutoff_smearing/">Energy cutoff smearing</a></li></ul></li><li><span class="tocitem">Response and properties</span><ul><li><a class="tocitem" href="../../examples/polarizability/">Polarizability by linear response</a></li><li><a class="tocitem" href="../../examples/forwarddiff/">Polarizability using automatic differentiation</a></li><li><a class="tocitem" href="../../examples/dielectric/">Eigenvalues of the dielectric matrix</a></li></ul></li><li><span class="tocitem">Ecosystem integration</span><ul><li><a class="tocitem" href="../../examples/atomsbase/">AtomsBase integration</a></li><li><a class="tocitem" href="../../examples/input_output/">Input and output formats</a></li><li><a class="tocitem" href="../../examples/wannier/">Wannierization using Wannier.jl or Wannier90</a></li></ul></li><li><span class="tocitem">Tipps and tricks</span><ul><li><a class="tocitem" href="../parallelization/">Timings and parallelization</a></li><li><a class="tocitem" href="../scf_checkpoints/">Saving SCF results on disk and SCF checkpoints</a></li><li class="is-active"><a class="tocitem" href>Using DFTK on compute clusters</a><ul class="internal"><li><a class="tocitem" href="#Julia-depot-path"><span>Julia depot path</span></a></li><li><a class="tocitem" href="#Installing-DFTK-into-a-local-Julia-environment"><span>Installing DFTK into a local Julia environment</span></a></li><li><a class="tocitem" href="#Setting-up-local-preferences"><span>Setting up local preferences</span></a></li><li><a class="tocitem" href="#Running-slurm-jobs"><span>Running slurm jobs</span></a></li><li><a class="tocitem" href="#Using-DFTK-via-the-Aiida-workflow-engine"><span>Using DFTK via the Aiida workflow engine</span></a></li></ul></li></ul></li><li><span class="tocitem">Solvers</span><ul><li><a class="tocitem" href="../../examples/custom_solvers/">Custom solvers</a></li><li><a class="tocitem" href="../../examples/scf_callbacks/">Monitoring self-consistent field calculations</a></li><li><a class="tocitem" href="../../examples/compare_solvers/">Comparison of DFT solvers</a></li></ul></li><li><span class="tocitem">Nonstandard models</span><ul><li><a class="tocitem" href="../../examples/gross_pitaevskii/">Gross-Pitaevskii equation in one dimension</a></li><li><a class="tocitem" href="../../examples/gross_pitaevskii_2D/">Gross-Pitaevskii equation with external magnetic field</a></li><li><a class="tocitem" href="../../examples/custom_potential/">Custom potential</a></li><li><a class="tocitem" href="../../examples/cohen_bergstresser/">Cohen-Bergstresser model</a></li><li><a class="tocitem" href="../../examples/anyons/">Anyonic models</a></li></ul></li><li><span class="tocitem">Error control</span><ul><li><a class="tocitem" href="../../examples/arbitrary_floattype/">Arbitrary floating-point types</a></li><li><a class="tocitem" href="../../examples/error_estimates_forces/">Practical error bounds for the forces</a></li></ul></li><li><span class="tocitem">Developer resources</span><ul><li><a class="tocitem" href="../../developer/setup/">Developer setup</a></li><li><a class="tocitem" href="../../developer/conventions/">Notation and conventions</a></li><li><a class="tocitem" href="../../developer/style_guide/">Developer&#39;s style guide</a></li><li><a class="tocitem" href="../../developer/data_structures/">Data structures</a></li><li><a class="tocitem" href="../../developer/useful_formulas/">Useful formulas</a></li><li><a class="tocitem" href="../../developer/symmetries/">Crystal symmetries</a></li><li><a class="tocitem" href="../../developer/gpu_computations/">GPU computations</a></li></ul></li><li><a class="tocitem" href="../../api/">API reference</a></li><li><a class="tocitem" href="../../publications/">Publications</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tipps and tricks</a></li><li class="is-active"><a href>Using DFTK on compute clusters</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Using DFTK on compute clusters</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JuliaMolSim/DFTK.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/JuliaMolSim/DFTK.jl/blob/master/docs/src/tricks/compute_clusters.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Using-DFTK-on-compute-clusters"><a class="docs-heading-anchor" href="#Using-DFTK-on-compute-clusters">Using DFTK on compute clusters</a><a id="Using-DFTK-on-compute-clusters-1"></a><a class="docs-heading-anchor-permalink" href="#Using-DFTK-on-compute-clusters" title="Permalink"></a></h1><p>This chapter summarises a few tips and tricks for running on compute clusters. It assumes you have already installed Julia on the machine in question (see <a href="https://julialang.org/downloads/">Julia downloads</a> and <a href="https://julialang.org/downloads/platform/">Julia installation instructions</a>).</p><p>We will use <a href="https://scitas-doc.epfl.ch/">EPFL&#39;s scitas clusters</a> as examples, but the basic principles should apply to other systems as well.</p><h2 id="Julia-depot-path"><a class="docs-heading-anchor" href="#Julia-depot-path">Julia depot path</a><a id="Julia-depot-path-1"></a><a class="docs-heading-anchor-permalink" href="#Julia-depot-path" title="Permalink"></a></h2><p>By default on Linux-based systems Julia puts all installed packages, including the binary packages into the path <code>$HOME/.julia</code>, which can easily take a few tens of GB. On many compute clusters the <code>/home</code> partition is on a shared filesystem (thus access is slower) and has a tight space quota. Usually it is therefore more advantageous to put Julia packages on a less persistent, <em>faster</em> filesystem. On many systems (such as <a href="https://scitas-doc.epfl.ch/user-guide/using-clusters/file-system/">EPFL scitas</a>) this is the <code>/scratch</code> partition. In your <code>~/.bashrc</code> or otherwise you should thus redirect the <code>JULIA_DEPOT_PATH</code> to be a subdirectory of <code>/scratch</code>.</p><p><strong>EPFL scitas.</strong> On scitas the right thing to do is to insert</p><pre><code class="nohighlight hljs">export JULIA_DEPOT_PATH=&quot;/scratch/$USER/.julia&quot;</code></pre><p>into your <code>~/.bashrc</code>.</p><h2 id="Installing-DFTK-into-a-local-Julia-environment"><a class="docs-heading-anchor" href="#Installing-DFTK-into-a-local-Julia-environment">Installing DFTK into a local Julia environment</a><a id="Installing-DFTK-into-a-local-Julia-environment-1"></a><a class="docs-heading-anchor-permalink" href="#Installing-DFTK-into-a-local-Julia-environment" title="Permalink"></a></h2><p>When employing a compute cluster, it is often desirable to integrate with the matching cluster-specific libraries, such as vendor-specific versions of BLAS, LAPACK etc. This is easiest achieved by installing <code>DFTK</code> not into the global Julia environment, but instead bundle the installation and the cluster-specific configuration in a local, cluster-specific environment.</p><p>On top of the discussion of the main <a href="../../guide/installation/#Installation">Installation</a> instructions, this requires one additional step, namely the use of a custom Julia package environment.</p><p><strong>Setting up a package environment.</strong> In the Julia REPL, create a new environment (essentially a new Julia project) using the following commands:</p><pre><code class="nohighlight hljs">import Pkg
Pkg.activate(&quot;path/to/new/environment&quot;)</code></pre><p>Replace <code>path/to/new/environment</code> with the directory where you wish to create the new environment. This will generate a folder containing <code>Project.toml</code> and <code>Manifest.toml</code> files. Both together provide a reproducible image of the packages you installed in your project. Once the <code>activate</code> call has been issued, you can than install packages as usual. E.g. use <code>Pkg.add(&quot;DFTK&quot;)</code> to install DFTK. The difference is that instead of tracking this in your <em>global</em> environment, the installations will be tracked in the local <code>Project.toml</code> and <code>Manifest.toml</code> files of the <code>path/to/new/environment</code> folder.</p><p>To start a Julia shell directly with such this environment activated, run it as <code>julia --project=path/to/new/environment</code>.</p><p><strong>Updating an environment.</strong> Start Julia and activate the environment. Then run <code>Pkg.update()</code>, i.e.</p><pre><code class="nohighlight hljs">import Pkg
Pkg.activate(&quot;path/to/new/environment&quot;)
Pkg.update()</code></pre><p>For more information on Julia environments, see the respective documentation on <a href="https://docs.julialang.org/en/v1/manual/code-loading/">Code loading</a> and on <a href="https://pkgdocs.julialang.org/v1/environments/">Managing Environments</a>.</p><h2 id="Setting-up-local-preferences"><a class="docs-heading-anchor" href="#Setting-up-local-preferences">Setting up local preferences</a><a id="Setting-up-local-preferences-1"></a><a class="docs-heading-anchor-permalink" href="#Setting-up-local-preferences" title="Permalink"></a></h2><p>On cluster machines often highly optimised versions of BLAS, LAPACK, FFTW, MPI or other basic packages are provided by the cluster vendor or operator. These can be used with DFTK by configuring an appropriate <code>LocalPreferences.toml</code> file, which tells Julia where the cluster-specific libraries are located. The following sections explain how to generate such a <code>LocalPreferences.toml</code> specific for your cluster. Once this file has been generated and sits next to a <code>Project.toml</code> in a Julia environment, it ensures that the cluster-specific libraries are used instead of the default ones. Therefore this  setup only needs to be done once per project.</p><p>A useful way to check whether the setup has been successful and <code>DFTK</code> indeed employs the desired cluster-specific libraries provides the</p><pre><code class="language-julia hljs">DFTK.versioninfo()</code></pre><p>command. It produces an output such as</p><pre><code class="nohighlight hljs">DFTK Version      0.6.16
Julia Version     1.10.0
FFTW.jl provider  fftw v3.3.10

BLAS.get_config()
  LinearAlgebra.BLAS.LBTConfig
  Libraries:
  └ [ILP64] libopenblas64_.so

MPI.versioninfo()
  MPIPreferences:
    binary:  MPICH_jll
    abi:     MPICH

  Package versions
    MPI.jl:             0.20.19
    MPIPreferences.jl:  0.1.10
    MPICH_jll:          4.1.2+1

  Library information:
    libmpi:  /home/mfh/.julia/artifacts/0ed4137b58af5c5e3797cb0c400e60ed7c308bae/lib/libmpi.so
    libmpi dlpath:  /home/mfh/.julia/artifacts/0ed4137b58af5c5e3797cb0c400e60ed7c308bae/lib/libmpi.so

[...]</code></pre><p>which thus specifies in one overview the details of the employed BLAS, LAPACK, FFTW, MPI, etc. libraries.</p><h3 id="Switching-to-MKL-for-BLAS-and-FFT"><a class="docs-heading-anchor" href="#Switching-to-MKL-for-BLAS-and-FFT">Switching to MKL for BLAS and FFT</a><a id="Switching-to-MKL-for-BLAS-and-FFT-1"></a><a class="docs-heading-anchor-permalink" href="#Switching-to-MKL-for-BLAS-and-FFT" title="Permalink"></a></h3><p>The <a href="https://github.com/JuliaLinearAlgebra/MKL.jl"><code>MKL</code></a> Julia package provides the Intel MKL library as a BLAS backend in Julia. To use fully use it you need to do two things:</p><ol><li>Add a <code>using MKL</code> to your scripts.</li><li>Configure a <code>LocalPreferences.jl</code> to employ the MKL also for FFT operations: to do so run the following Julia script:<pre><code class="language-julia hljs">using MKL
using FFTW
FFTW.set_provider!(&quot;mkl&quot;)</code></pre></li></ol><h3 id="Switching-to-the-system-provided-MPI-library"><a class="docs-heading-anchor" href="#Switching-to-the-system-provided-MPI-library">Switching to the system-provided MPI library</a><a id="Switching-to-the-system-provided-MPI-library-1"></a><a class="docs-heading-anchor-permalink" href="#Switching-to-the-system-provided-MPI-library" title="Permalink"></a></h3><p>To use a system-provided MPI library, load the required modules. On scitas that is</p><pre><code class="language-sh hljs">module load gcc
module load openmpi</code></pre><p>Afterwards follow the <a href="https://juliaparallel.org/MPI.jl/stable/configuration/#configure_system_binary">MPI system binary instructions</a> and execute</p><pre><code class="language-julia hljs">using MPIPreferences
MPIPreferences.use_system_binary()</code></pre><h2 id="Running-slurm-jobs"><a class="docs-heading-anchor" href="#Running-slurm-jobs">Running slurm jobs</a><a id="Running-slurm-jobs-1"></a><a class="docs-heading-anchor-permalink" href="#Running-slurm-jobs" title="Permalink"></a></h2><p>This example shows how to run a DFTK calculation on a slurm-based system such as scitas. We use the MKL for FFTW and BLAS and the system-provided MPI. This setup will create five files <code>LocalPreferences.toml</code>, <code>Project.toml</code>, <code>dftk.jl</code>, <code>silicon.extxyz</code> and <code>job.sh</code>.</p><p>At the time of writing (Dec 2023) following the setup indicated above leads to this <code>LocalPreferences.toml</code> file:</p><pre><code class="language-toml hljs">[FFTW]
provider = &quot;mkl&quot;

[MPIPreferences]
__clear__ = [&quot;preloads_env_switch&quot;]
_format = &quot;1.0&quot;
abi = &quot;OpenMPI&quot;
binary = &quot;system&quot;
cclibs = []
libmpi = &quot;libmpi&quot;
mpiexec = &quot;mpiexec&quot;
preloads = []</code></pre><p>We place this into a folder next to a <code>Project.toml</code> to define our project:</p><pre><code class="language-toml hljs">[deps]
AtomsIO = &quot;1692102d-eeb4-4df9-807b-c9517f998d44&quot;
DFTK = &quot;acf6eb54-70d9-11e9-0013-234b7a5f5337&quot;
FFTW = &quot;7a1cc6ca-52ef-59f5-83cd-3a7055c09341&quot;
MKL = &quot;33e6dc65-8f57-5167-99aa-e5a354878fb2&quot;
MPIPreferences = &quot;3da0fdf6-3ccc-4f1b-acd9-58baa6c99267&quot;</code></pre><p>We additionally create a small file <code>dftk.jl</code> to run an MPI-parallelised calculation from a passed structure</p><pre><code class="language-julia hljs">using MKL
using DFTK
using AtomsIO

disable_threading()  # Threading and MPI not compatible

function main(structure, pseudos; Ecut, kspacing)
    if mpi_master()
        println(&quot;DEPOT_PATH=$DEPOT_PATH&quot;)
        println(DFTK.versioninfo())
        println()
    end

    system = attach_psp(load_system(structure); pseudos...)
    model  = model_PBE(system; temperature=1e-3, smearing=Smearing.MarzariVanderbilt())

    kgrid = kgrid_from_minimal_spacing(model, kspacing)
    basis = PlaneWaveBasis(model; Ecut, kgrid)

    if mpi_master()
        println()
        show(stdout, MIME(&quot;text/plain&quot;), basis)
        println()
        flush(stdout)
    end

    DFTK.reset_timer!(DFTK.timer)
    scfres = self_consistent_field(basis)
    println(DFTK.timer)

    if mpi_master()
        show(stdout, MIME(&quot;text/plain&quot;), scfres.energies)
    end
end</code></pre><p>and we dump the structure file <code>silicon.extxyz</code> with content</p><pre><code class="nohighlight hljs">2
pbc=[T, T, T] Lattice=&quot;0.00000000 2.71467909 2.71467909 2.71467909 0.00000000 2.71467909 2.71467909 2.71467909 0.00000000&quot; Properties=species:S:1:pos:R:3
Si         0.67866977       0.67866977       0.67866977
Si        -0.67866977      -0.67866977      -0.67866977</code></pre><p>Finally the jobscript <code>job.sh</code> for a slurm job looks like this:</p><pre><code class="language-sh hljs">#!/bin/bash
# This is the block interpreted by slurm and used as a Job submission script.
# The actual julia payload is in dftk.jl
# In this case it sets the parameters for running with 2 MPI processes using a maximal
# wall time of 2 hours.

#SBATCH --time 2:00:00
#SBATCH --nodes 1
#SBATCH --ntasks 2
#SBATCH --cpus-per-task 1

# Now comes the setup of the environment on the cluster node (the &quot;jobscript&quot;)

# IMPORTANT: Set Julia&#39;s depot path to be a local scratch
# direction (not your home !).
export JULIA_DEPOT_PATH=&quot;/scratch/$USER/.julia&quot;

# Load modules to setup julia (this is specific to EPFL scitas systems)
module purge
module load gcc
module load openmpi
module load julia

# Run the actual payload of Julia using 1 thread. Use the name of this
# file as an include to make everything self-contained.
srun julia -t 1 --project -e &#39;
    include(&quot;dftk.jl&quot;)
    pseudos = (; Si=&quot;hgh/pbe/si-q4.hgh&quot; )
    main(&quot;silicon.extxyz&quot;,
         pseudos;
         Ecut=10,
         kspacing=0.3,
 )
&#39;</code></pre><h2 id="Using-DFTK-via-the-Aiida-workflow-engine"><a class="docs-heading-anchor" href="#Using-DFTK-via-the-Aiida-workflow-engine">Using DFTK via the Aiida workflow engine</a><a id="Using-DFTK-via-the-Aiida-workflow-engine-1"></a><a class="docs-heading-anchor-permalink" href="#Using-DFTK-via-the-Aiida-workflow-engine" title="Permalink"></a></h2><p>A preliminary integration of DFTK with the <a href="https://www.aiida.net/">Aiida</a> high-throughput workflow engine is available via the <a href="https://github.com/aiidaplugins/aiida-dftk">aiida-dftk</a> plugin. This can be a useful alternative if many similar DFTK calculations should be run.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../scf_checkpoints/">« Saving SCF results on disk and SCF checkpoints</a><a class="docs-footer-nextpage" href="../../examples/custom_solvers/">Custom solvers »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.1.2 on <span class="colophon-date" title="Monday 15 January 2024 13:24">Monday 15 January 2024</span>. Using Julia version 1.10.0.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
