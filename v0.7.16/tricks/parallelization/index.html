<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Timings and parallelization · DFTK.jl</title><meta name="title" content="Timings and parallelization · DFTK.jl"/><meta property="og:title" content="Timings and parallelization · DFTK.jl"/><meta property="twitter:title" content="Timings and parallelization · DFTK.jl"/><meta name="description" content="Documentation for DFTK.jl."/><meta property="og:description" content="Documentation for DFTK.jl."/><meta property="twitter:description" content="Documentation for DFTK.jl."/><meta property="og:url" content="https://docs.dftk.org/stable/tricks/parallelization/"/><meta property="twitter:url" content="https://docs.dftk.org/stable/tricks/parallelization/"/><link rel="canonical" href="https://docs.dftk.org/stable/tricks/parallelization/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/favicon.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="DFTK.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">DFTK.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../features/">DFTK features</a></li><li><span class="tocitem">Getting started</span><ul><li><a class="tocitem" href="../../guide/installation/">Installation</a></li><li><a class="tocitem" href="../../guide/tutorial/">Tutorial</a></li></ul></li><li><span class="tocitem">Background</span><ul><li><a class="tocitem" href="../../guide/introductory_resources/">Introductory resources</a></li><li><a class="tocitem" href="../../guide/periodic_problems/">Periodic problems and plane-wave discretisations</a></li><li><a class="tocitem" href="../../guide/discretisation/">Comparing discretization techniques</a></li><li><a class="tocitem" href="../../guide/atomic_chains/">Modelling atomic chains</a></li><li><a class="tocitem" href="../../guide/density_functional_theory/">Introduction to density-functional theory</a></li><li><a class="tocitem" href="../../guide/self_consistent_field/">Self-consistent field methods</a></li><li><a class="tocitem" href="../../school2022/">DFTK School 2022</a></li></ul></li><li><span class="tocitem">Basic DFT calculations</span><ul><li><a class="tocitem" href="../../examples/metallic_systems/">Temperature and metallic systems</a></li><li><a class="tocitem" href="../../examples/collinear_magnetism/">Collinear spin and magnetic systems</a></li><li><a class="tocitem" href="../../examples/convergence_study/">Performing a convergence study</a></li><li><a class="tocitem" href="../../examples/pseudopotentials/">Pseudopotentials</a></li><li><a class="tocitem" href="../../examples/supercells/">Creating and modelling metallic supercells</a></li><li><a class="tocitem" href="../../examples/gaas_surface/">Modelling a gallium arsenide surface</a></li><li><a class="tocitem" href="../../examples/graphene/">Graphene band structure</a></li><li><a class="tocitem" href="../../examples/geometry_optimization/">Geometry optimization</a></li><li><a class="tocitem" href="../../examples/energy_cutoff_smearing/">Energy cutoff smearing</a></li></ul></li><li><span class="tocitem">Response and properties</span><ul><li><a class="tocitem" href="../../examples/polarizability/">Polarizability by linear response</a></li><li><a class="tocitem" href="../../examples/forwarddiff/">Polarizability using automatic differentiation</a></li><li><a class="tocitem" href="../../examples/phonons/">Phonon computations</a></li></ul></li><li><span class="tocitem">Ecosystem integration</span><ul><li><a class="tocitem" href="../../ecosystem/atomsbase/">AtomsBase integration</a></li><li><a class="tocitem" href="../../ecosystem/atomscalculators/">AtomsCalculators integration</a></li><li><a class="tocitem" href="../../ecosystem/input_output/">Input and output formats</a></li><li><a class="tocitem" href="../../ecosystem/atomistic_simulation_environment/">Atomistic simulation environment (ASE)</a></li><li><a class="tocitem" href="../../ecosystem/wannier/">Wannierization using Wannier.jl or Wannier90</a></li></ul></li><li><span class="tocitem">Tips and tricks</span><ul><li><a class="tocitem" href="../achieving_convergence/">Achieving DFT convergence</a></li><li class="is-active"><a class="tocitem" href>Timings and parallelization</a><ul class="internal"><li><a class="tocitem" href="#Timing-measurements"><span>Timing measurements</span></a></li><li><a class="tocitem" href="#Rough-timing-estimates"><span>Rough timing estimates</span></a></li><li><a class="tocitem" href="#Options-for-parallelization"><span>Options for parallelization</span></a></li><li><a class="tocitem" href="#MPI-based-parallelism"><span>MPI-based parallelism</span></a></li><li><a class="tocitem" href="#Thread-based-parallelism"><span>Thread-based parallelism</span></a></li><li><a class="tocitem" href="#Advanced-threading-tweaks"><span>Advanced threading tweaks</span></a></li></ul></li><li><a class="tocitem" href="../gpu/">Using DFTK on GPUs</a></li><li><a class="tocitem" href="../scf_checkpoints/">Saving SCF results on disk and SCF checkpoints</a></li><li><a class="tocitem" href="../compute_clusters/">Using DFTK on compute clusters</a></li></ul></li><li><span class="tocitem">Solvers</span><ul><li><a class="tocitem" href="../../examples/custom_solvers/">Custom solvers</a></li><li><a class="tocitem" href="../../examples/scf_callbacks/">Monitoring self-consistent field calculations</a></li><li><a class="tocitem" href="../../examples/compare_solvers/">Comparison of DFT solvers</a></li><li><a class="tocitem" href="../../examples/analysing_scf_convergence/">Analysing SCF convergence</a></li></ul></li><li><span class="tocitem">Nonstandard models</span><ul><li><a class="tocitem" href="../../examples/gross_pitaevskii/">Gross-Pitaevskii equation in one dimension</a></li><li><a class="tocitem" href="../../examples/gross_pitaevskii_2D/">Gross-Pitaevskii equation with external magnetic field</a></li><li><a class="tocitem" href="../../examples/custom_potential/">Custom potential</a></li><li><a class="tocitem" href="../../examples/cohen_bergstresser/">Cohen-Bergstresser model</a></li><li><a class="tocitem" href="../../examples/anyons/">Anyonic models</a></li></ul></li><li><span class="tocitem">Error control</span><ul><li><a class="tocitem" href="../../examples/arbitrary_floattype/">Arbitrary floating-point types</a></li><li><a class="tocitem" href="../../examples/error_estimates_forces/">Practical error bounds for the forces</a></li></ul></li><li><span class="tocitem">Developer resources</span><ul><li><a class="tocitem" href="../../developer/setup/">Developer setup</a></li><li><a class="tocitem" href="../../developer/testsystem/">Unit test system</a></li><li><a class="tocitem" href="../../developer/conventions/">Notation and conventions</a></li><li><a class="tocitem" href="../../developer/style_guide/">Developer&#39;s style guide</a></li><li><a class="tocitem" href="../../developer/data_structures/">Data structures</a></li><li><a class="tocitem" href="../../developer/useful_formulas/">Useful formulas</a></li><li><a class="tocitem" href="../../developer/symmetries/">Crystal symmetries</a></li><li><a class="tocitem" href="../../developer/gpu_computations/">GPU computations</a></li></ul></li><li><a class="tocitem" href="../../api/">API reference</a></li><li><a class="tocitem" href="../../publications/">Publications</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tips and tricks</a></li><li class="is-active"><a href>Timings and parallelization</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Timings and parallelization</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JuliaMolSim/DFTK.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/JuliaMolSim/DFTK.jl/blob/master/docs/src/tricks/parallelization.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Timings-and-parallelization"><a class="docs-heading-anchor" href="#Timings-and-parallelization">Timings and parallelization</a><a id="Timings-and-parallelization-1"></a><a class="docs-heading-anchor-permalink" href="#Timings-and-parallelization" title="Permalink"></a></h1><p>This section summarizes the options DFTK offers to monitor and influence performance of the code.</p><h2 id="Timing-measurements"><a class="docs-heading-anchor" href="#Timing-measurements">Timing measurements</a><a id="Timing-measurements-1"></a><a class="docs-heading-anchor-permalink" href="#Timing-measurements" title="Permalink"></a></h2><p>By default DFTK uses <a href="https://github.com/KristofferC/TimerOutputs.jl">TimerOutputs.jl</a> to record timings, memory allocations and the number of calls for selected routines inside the code. These numbers are accessible in the object <code>DFTK.timer</code>. Since the timings are automatically accumulated inside this datastructure, any timing measurement should first reset this timer before running the calculation of interest.</p><p>For example to measure the timing of an SCF:</p><pre><code class="language-julia hljs">DFTK.reset_timer!(DFTK.timer)
scfres = self_consistent_field(basis, tol=1e-5)

DFTK.timer</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi"><span class="sgr1">────────────────────────────────────────────────────────────────────────────────</span>
<span class="sgr1">                              </span>         Time                    Allocations      
                              ───────────────────────   ────────────────────────
      Tot / % measured:            275ms /  51.1%           67.6MiB /  81.1%    

Section               ncalls     time    %tot     avg     alloc    %tot      avg
────────────────────────────────────────────────────────────────────────────────
self_consistent_field      1    141ms  100.0%   141ms   54.8MiB  100.0%  54.8MiB
  LOBPCG                  27   63.2ms   44.9%  2.34ms   14.0MiB   25.5%   530KiB
    DftHamiltonian...     75   52.4ms   37.3%   699μs   4.53MiB    8.3%  61.9KiB
      local+kinetic      492   50.5ms   35.9%   103μs    269KiB    0.5%     560B
      nonlocal            75    852μs    0.6%  11.4μs    317KiB    0.6%  4.23KiB
    rayleigh_ritz         48   3.96ms    2.8%  82.4μs   1.64MiB    3.0%  35.0KiB
      ortho!              48    388μs    0.3%  8.09μs    208KiB    0.4%  4.33KiB
    ortho! X vs Y         69   2.90ms    2.1%  42.1μs   1.60MiB    2.9%  23.8KiB
      ortho!             137   1.62ms    1.1%  11.8μs    845KiB    1.5%  6.17KiB
    Update residuals      75    503μs    0.4%  6.70μs   1.12MiB    2.0%  15.2KiB
    ortho!                27    388μs    0.3%  14.4μs    134KiB    0.2%  4.97KiB
    preconditioning       75    284μs    0.2%  3.79μs   8.03KiB    0.0%     110B
  energy_hamiltonian      10   30.9ms   21.9%  3.09ms   14.3MiB   26.2%  1.43MiB
    ene_ops               10   29.4ms   20.9%  2.94ms   10.5MiB   19.1%  1.05MiB
      ene_ops: local      10   16.5ms   11.8%  1.65ms    937KiB    1.7%  93.7KiB
      ene_ops: xc         10   10.3ms    7.3%  1.03ms   4.68MiB    8.5%   479KiB
      ene_ops: har...     10   1.93ms    1.4%   193μs   4.51MiB    8.2%   462KiB
      ene_ops: non...     10    308μs    0.2%  30.8μs    148KiB    0.3%  14.8KiB
      ene_ops: kin...     10    221μs    0.2%  22.1μs    122KiB    0.2%  12.2KiB
  compute_density          9   30.4ms   21.6%  3.38ms   5.78MiB   10.6%   658KiB
    symmetrize_ρ           9   24.4ms   17.4%  2.71ms   4.45MiB    8.1%   507KiB
  energy                   9   11.1ms    7.9%  1.23ms   9.45MiB   17.3%  1.05MiB
    ene_ops: xc            9   9.11ms    6.5%  1.01ms   4.21MiB    7.7%   479KiB
    ene_ops: hartree       9   1.27ms    0.9%   141μs   4.06MiB    7.4%   462KiB
    ene_ops: nonlocal      9    252μs    0.2%  28.0μs    148KiB    0.3%  16.5KiB
    ene_ops: kinetic       9    216μs    0.2%  24.0μs    113KiB    0.2%  12.6KiB
    ene_ops: local         9    121μs    0.1%  13.4μs    843KiB    1.5%  93.7KiB
  Anderson acceler...      8   2.11ms    1.5%   264μs   4.45MiB    8.1%   570KiB
  ortho_qr                 3    125μs    0.1%  41.6μs    101KiB    0.2%  33.7KiB
  χ0Mixing                 9   39.6μs    0.0%  4.40μs   41.1KiB    0.1%  4.56KiB
enforce_real!              1   63.0μs    0.0%  63.0μs      384B    0.0%     384B
<span class="sgr1">────────────────────────────────────────────────────────────────────────────────</span></code></pre><p>The output produced when printing or displaying the <code>DFTK.timer</code> now shows a nice table summarising total time and allocations as well as a breakdown over individual routines.</p><div class="admonition is-info"><header class="admonition-header">Timing measurements and stack traces</header><div class="admonition-body"><p>Timing measurements have the unfortunate disadvantage that they alter the way stack traces look making it sometimes harder to find errors when debugging. For this reason timing measurements can be disabled completely (i.e. not even compiled into the code) by setting the package-level preference <code>DFTK.set_timer_enabled!(false)</code>. You will need to restart your Julia session afterwards to take this into account.</p></div></div><h2 id="Rough-timing-estimates"><a class="docs-heading-anchor" href="#Rough-timing-estimates">Rough timing estimates</a><a id="Rough-timing-estimates-1"></a><a class="docs-heading-anchor-permalink" href="#Rough-timing-estimates" title="Permalink"></a></h2><p>A very (very) rough estimate of the time per SCF step (in seconds) can be obtained with the following function. The function assumes that FFTs are the limiting operation and that no parallelisation is employed.</p><pre><code class="language-julia hljs">function estimate_time_per_scf_step(basis::PlaneWaveBasis)
    # Super rough figure from various tests on cluster, laptops, ... on a 128^3 FFT grid.
    time_per_FFT_per_grid_point = 30 #= ms =# / 1000 / 128^3

    (time_per_FFT_per_grid_point
     * prod(basis.fft_size)
     * length(basis.kpoints)
     * div(basis.model.n_electrons, DFTK.filled_occupation(basis.model), RoundUp)
     * 8  # mean number of FFT steps per state per k-point per iteration
     )
end

&quot;Time per SCF (s):  $(estimate_time_per_scf_step(basis))&quot;</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">&quot;Time per SCF (s):  0.008009033203124998&quot;</code></pre><h2 id="Options-for-parallelization"><a class="docs-heading-anchor" href="#Options-for-parallelization">Options for parallelization</a><a id="Options-for-parallelization-1"></a><a class="docs-heading-anchor-permalink" href="#Options-for-parallelization" title="Permalink"></a></h2><p>At the moment DFTK offers two ways to parallelize a calculation, firstly shared-memory parallelism using threading and secondly multiprocessing using MPI (via the <a href="https://github.com/JuliaParallel/MPI.jl">MPI.jl</a> Julia interface). MPI-based parallelism is currently only over <span>$k$</span>-points, such that it cannot be used for calculations with only a single <span>$k$</span>-point. There is also support for <a href="../gpu/#Using-DFTK-on-GPUs">Using DFTK on GPUs</a>.</p><p>The scaling of both forms of parallelism for a number of test cases is demonstrated in the following figure. These values were obtained using DFTK version 0.1.17 and Julia 1.6 and the precise scalings will likely be different depending on architecture, DFTK or Julia version. The rough trends should, however, be similar.</p><img src="../scaling.png" width=750 /><p>The MPI-based parallelization strategy clearly shows a superior scaling and should be preferred if available.</p><h2 id="MPI-based-parallelism"><a class="docs-heading-anchor" href="#MPI-based-parallelism">MPI-based parallelism</a><a id="MPI-based-parallelism-1"></a><a class="docs-heading-anchor-permalink" href="#MPI-based-parallelism" title="Permalink"></a></h2><p>Currently DFTK uses MPI to distribute on <span>$k$</span>-points only. This implies that calculations with only a single <span>$k$</span>-point cannot use make use of this. For details on setting up and configuring MPI with Julia see the <a href="https://juliaparallel.github.io/MPI.jl/stable/configuration">MPI.jl documentation</a>.</p><ol><li><p>First disable all threading inside DFTK, by adding the following to your script running the DFTK calculation:</p><pre><code class="language-julia hljs">using DFTK
disable_threading()</code></pre></li><li><p>Run Julia in parallel using the <code>mpiexecjl</code> wrapper script from MPI.jl:</p><pre><code class="language-sh hljs">mpiexecjl -np 16 julia myscript.jl</code></pre><p>In this <code>-np 16</code> tells MPI to use 16 processes and <code>-t 1</code> tells Julia to use one thread only. Notice that we use <code>mpiexecjl</code> to automatically select the <code>mpiexec</code> compatible with the MPI version used by MPI.jl.</p></li></ol><p>As usual with MPI printing will be garbled. You can use</p><pre><code class="language-julia hljs">DFTK.mpi_master() || (redirect_stdout(); redirect_stderr())</code></pre><p>at the top of your script to disable printing on all processes but one.</p><div class="admonition is-info"><header class="admonition-header">MPI-based parallelism not supported everywhere</header><div class="admonition-body"><p>While most standard procedures are now supported in combination with MPI, some functionality is still missing and may error out when being called in an MPI-parallel run. In most cases there is no intrinsic limitation it just has not yet been implemented. If you require MPI in one of our routines, where this is not yet supported, feel free to open an issue on github or otherwise get in touch.</p></div></div><h2 id="Thread-based-parallelism"><a class="docs-heading-anchor" href="#Thread-based-parallelism">Thread-based parallelism</a><a id="Thread-based-parallelism-1"></a><a class="docs-heading-anchor-permalink" href="#Thread-based-parallelism" title="Permalink"></a></h2><p>Threading in DFTK currently happens on multiple layers distributing the workload over different <span>$k$</span>-points, bands or within an FFT or BLAS call between threads. At its current stage our scaling for thread-based parallelism is worse compared MPI-based and therefore the parallelism described here should only be used if no other option exists. To use thread-based parallelism proceed as follows:</p><ol><li><p>Ensure that threading is properly setup inside DFTK by adding to the script running the DFTK calculation:</p><pre><code class="language-julia hljs">using DFTK
setup_threading()</code></pre><p>This disables FFT threading and sets the number of BLAS threads to the number of Julia threads.</p></li><li><p>Run Julia passing the desired number of threads using the flag <code>-t</code>:</p><pre><code class="language-sh hljs">julia -t 8 myscript.jl</code></pre></li></ol><p>For some cases (e.g. a single <span>$k$</span>-point, fewish bands and a large FFT grid) it can be advantageous to add threading inside the FFTs as well. One example is the Caffeine calculation in the above scaling plot. In order to do so just call <code>setup_threading(n_fft=2)</code>, which will select two FFT threads. More than two FFT threads is rarely useful.</p><h2 id="Advanced-threading-tweaks"><a class="docs-heading-anchor" href="#Advanced-threading-tweaks">Advanced threading tweaks</a><a id="Advanced-threading-tweaks-1"></a><a class="docs-heading-anchor-permalink" href="#Advanced-threading-tweaks" title="Permalink"></a></h2><p>The default threading setup done by <code>setup_threading</code> is to select one FFT thread, and use <code>Threads.nthreads()</code> to determine the number of DFTK and BLAS threads. This section provides some info in case you want to change these defaults.</p><h3 id="BLAS-threads"><a class="docs-heading-anchor" href="#BLAS-threads">BLAS threads</a><a id="BLAS-threads-1"></a><a class="docs-heading-anchor-permalink" href="#BLAS-threads" title="Permalink"></a></h3><p>All BLAS calls in Julia go through a parallelized OpenBlas or MKL (with <a href="https://github.com/JuliaComputing/MKL.jl">MKL.jl</a>. Generally threading in BLAS calls is far from optimal and the default settings can be pretty bad. For example for CPUs with hyper threading enabled, the default number of threads seems to equal the number of <em>virtual</em> cores. Still, BLAS calls typically take second place in terms of the share of runtime they make up (between 10% and 20%). Of note many of these do not take place on matrices of the size of the full FFT grid, but rather only in a subspace (e.g. orthogonalization, Rayleigh-Ritz, ...) such that parallelization is either anyway disabled by the BLAS library or not very effective. To <strong>set the number of BLAS threads</strong> use</p><pre><code class="language-julia hljs">using LinearAlgebra
BLAS.set_num_threads(N)</code></pre><p>where <code>N</code> is the number of threads you desire. To <strong>check the number of BLAS threads</strong> currently used, you can use <code>BLAS.get_num_threads()</code>.</p><h3 id="DFTK-threads"><a class="docs-heading-anchor" href="#DFTK-threads">DFTK threads</a><a id="DFTK-threads-1"></a><a class="docs-heading-anchor-permalink" href="#DFTK-threads" title="Permalink"></a></h3><p>On top of BLAS threading DFTK uses Julia threads in a couple of places to parallelize over <span>$k$</span>-points (density computation) or bands (Hamiltonian application). The number of threads used for these aspects is controlled by default by <code>Threads.nthreads()</code>, which can be set using the flag <code>-t</code> passed to Julia or the <em>environment variable</em> <code>JULIA_NUM_THREADS</code>. Optionally, you can use <code>setup_threading(; n_DFTK)</code> to set an upper bound to the number of threads used by DFTK, regardless of <code>Threads.nthreads()</code> (for instance, if you want to thread several DFTK runs and don&#39;t want DFTK&#39;s threading to interfere with that).</p><h3 id="FFT-threads"><a class="docs-heading-anchor" href="#FFT-threads">FFT threads</a><a id="FFT-threads-1"></a><a class="docs-heading-anchor-permalink" href="#FFT-threads" title="Permalink"></a></h3><p>Since FFT threading is only used in DFTK inside the regions already parallelized by Julia threads, setting FFT threads to something larger than <code>1</code> is rarely useful if a sensible number of Julia threads has been chosen. Still, to explicitly <strong>set the FFT threads</strong> use</p><pre><code class="language-julia hljs">using FFTW
FFTW.set_num_threads(N)</code></pre><p>where <code>N</code> is the number of threads you desire. By default no FFT threads are used, which is almost always the best choice.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../achieving_convergence/">« Achieving DFT convergence</a><a class="docs-footer-nextpage" href="../gpu/">Using DFTK on GPUs »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.1 on <span class="colophon-date" title="Wednesday 2 July 2025 18:39">Wednesday 2 July 2025</span>. Using Julia version 1.11.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
